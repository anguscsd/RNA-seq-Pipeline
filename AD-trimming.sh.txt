#!/bin/bash

sampleIDs=("ERR2704713_subset")
contamFile="TruSeq3-PE.fa"

userProject="scw1557"
mem="20G"
nodes="1"
runTime="00:05:00"

myDir=$(pwd)
scriptBase="02"
jobName="ADtrim"

## loop over each sample in turn

for sampleID in "${sampleIDs[@]}"
do

	## write a script to the temp/ directory (one for each sample)

	scriptName=${myDir}/../temp/${scriptBase}.${sampleID}.sh

	## remove the script if it exists already

	rm -rf ${scriptName} || true

	## make an empty script for writing

	touch ${scriptName}

	## write the SLURM parameters to the top of the script

	echo "#!/bin/bash" >> ${scriptName} 
        echo "#SBATCH -p compute" >> ${scriptName}
        echo "#SBATCH --mem=${mem}" >> ${scriptName}
        echo "#SBATCH --ntasks=${nodes}" >> ${scriptName}
        echo "#SBATCH --tasks-per-node=${nodes}" >> ${scriptName}
        echo "#SBATCH -t ${runTime}" >> ${scriptName}
        echo "#SBATCH -o ${myDir}/OUT/${scriptBase}${jobName}.%J" >> ${scriptName}
        echo "#SBATCH -e ${myDir}/ERR/${scriptBase}${jobName}.%J" >> ${scriptName}
        echo "#SBATCH --job-name=${jobName}" >> ${scriptName}
        echo "#SBATCH --account=${userProject}" >> ${scriptName}

	## load the java and trimmomatic modules

	echo "module load java/1.8" >> ${scriptName}	
	echo "module load trimmomatic/0.38" >> ${scriptName}	

	## make a directory for each sample under the ../output/ directory

	echo "mkdir -p ${myDir}/../output/${sampleID}/trimmomatic" >> ${scriptName}	

	## run the trimmomatic command

	echo "java -jar /apps/genomics/trimmomatic/0.38/trimmomatic-0.38.jar PE -phred33 \
${myDir}/../input/${sampleID}_1.fastq.gz ${myDir}/../input/${sampleID}_2.fastq.gz \
${myDir}/../output/${sampleID}/trimmomatic/${sampleID}.trim_1.fq.gz \
${myDir}/../output/${sampleID}/trimmomatic/${sampleID}.trim.unpaired_1.fq.gz \
${myDir}/../output/${sampleID}/trimmomatic/${sampleID}.trim_2.fq.gz \
${myDir}/../output/${sampleID}/trimmomatic/${sampleID}.trim.unpaired_2.fq.gz \
ILLUMINACLIP:${myDir}/../resources/${contamFile}:2:30:10 \
LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:26" >> ${scriptName}

	## make the script into an 'executable'

	chmod u+x ${scriptName}

	## submit the script to the compute queue

	sbatch ${scriptName}

done

